<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" type="text/css" href="styles/emptype.css">
	<link rel="stylesheet" type="text/css" href="styles/modal.css">
	<script>
		function debounce(func, wait, immediate) {
			var timeout;
  		return function executedFunction() {
		    var context = this;
		    var args = arguments;
	    	var later = function() {
	      	timeout = null;
	      	if (!immediate) {
	      		func.apply(context, args);
	      	}
	    	};
	    	var callNow = immediate && !timeout;
	    	clearTimeout(timeout);
	    	timeout = setTimeout(later, wait);
	    	if (callNow) {
	    		func.apply(context, args);
	    	}
  		};
		};
		function addColor() {
			addSelectedValue(document.querySelector('#colors').value);
		}
		function addGlyph() {
			addSelectedValue(document.querySelector('#glyphs').value);
		}
		function addAsciiEmoji() {
			addSelectedValue(document.querySelector('#ascii').value);
		}
		function addSelectedValue(valueToAdd) {
			var area = document.querySelector('#area');
			var startPos = area.selectionStart;
        var endPos = area.selectionEnd;
        area.value = area.value.substring(0, startPos)
            + valueToAdd
            + area.value.substring(endPos, area.value.length);
			updateDiv();
			area.focus();
		}
		function updateDiv() {
			var areatxt = document.querySelector('#area').value;
			// Look for colors to replace:
			while (areatxt.indexOf('[') >= 0) {
				var start = areatxt.indexOf('[');
				var end = areatxt.indexOf(']');
				var colorHex = areatxt.substring(start + 1, end);
				areatxt = areatxt.replace(/\[.*?\]/, `</span><span style="color:${colorHex}">`)
			}
			// Look for glyphs to replace:
			GLYPHS.forEach(glyph => {
				var ix = areatxt.indexOf(`:${glyph}:`);
				if (ix >= 0) {
					var imgsrc = `img/glyphs/${glyph}.png`;
					areatxt = areatxt.replace(new RegExp(`:${glyph}:`, 'g'), `<img src=${imgsrc}>`);
				}
			});
			document.querySelector('#divtext').innerHTML = `<span>${areatxt}</span>`;
		}
		function copyText() {
			var area = document.querySelector('#area');
			area.select();
			document.execCommand('copy');
		}
		function initGlyphSelect() {
			var select = document.querySelector('#glyphs');
			GLYPHS.forEach(glyph => {
				select.options[select.options.length] = new Option(glyph, `:${glyph}:`);
			});
		}
		function initColorSelect() {
			var select = document.querySelector('#colors');
			for (var color in COLORS) {
    		if (COLORS.hasOwnProperty(color)) {
    			select.options[select.options.length] = new Option(color, COLORS[color]);
				}
			}
		}
		function initAsciiSelect() {
			var select = document.querySelector('#ascii');
			ASCII.forEach(ascii => {
				select.options[select.options.length] = new Option(ascii, ascii);
			});
		}
	</script>
</head>
<body>
	<div class='text'>
		<textarea id='area' name='area' cols='2' rows='4''></textarea>
	</div>
	<div class='controls'>
		<span>
			<select class='colors' id='colors' name='colors' onChange='addColor()'>
				<option disabled selected>Colors</option>
			</select>
		</span>
		<span>
			<select class='glyphs' id='glyphs' name='glyphs' onChange='addGlyph()'>
				<option disabled selected>Glyphs</option>
			</select>
		</span>
		<span>
			<select class='ascii' id='ascii' name='ascii' onChange='addAsciiEmoji()'>
				<option disabled selected>Emoji</option>
			</select>
		</span>
	</div>
	<div class='divtext' id='divtext' name='divtext' onClick='copyText()'>
	</div>

	<div id="modalTrigger"><img src='img/glyphs/richard.png'></div>
	<!-- The Modal -->
	<div id="myModal" class="modal">
	  <!-- Modal content -->
	  <div class="modal-content">
	    <span class="close">&times;</span>
	    <img class='glyphs-ref-img' src='img/glyphs-ref.jpg'></div>
	  </div>
	</div>

	<script type="text/javascript" src="script/constants.js" charset="UTF-8"></script>
	<script type="text/javascript" src="script/modal.js"></script> 
	<script>
		initColorSelect();
		initGlyphSelect();
		initAsciiSelect();
		var updateDivDebounced = debounce(function() {
			updateDiv();
		}, 750);
		window.addEventListener('keyup', updateDivDebounced);
	</script>
</body>
</html>